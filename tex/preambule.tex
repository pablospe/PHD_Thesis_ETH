%%%%%%%%% PREAMBLE

% \usepackage[automark]{scrpage2}   % obsolete (use 'scrlayer-scrpage')
% https://tex.stackexchange.com/a/541772
\usepackage[automark]{scrlayer-scrpage}

\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,factor=1100,stretch=10,shrink=10]{microtype}
% activate={true,nocompatibility} - activate protrusion and expansion
% final - enable microtype; use "draft" to disable
% tracking=true, kerning=true, spacing=true - activate these techniques
% factor=1100 - add 10% to the protrusion amount (default is 1000)
% stretch=10, shrink=10 - reduce stretchability/shrinkability (default is 20/20)

\makeatother

\pagestyle{scrheadings}
\addtolength{\oddsidemargin}{1.0cm}
\addtolength{\evensidemargin}{-1.0cm}

\usepackage{lipsum}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{cite}
\usepackage{booktabs}
\usepackage{enumitem}


% \Mark is probably provided by spconf, that I don't have
\newcommand{\Mark}[1]{\textsuperscript{#1}}

% Footnote without a marker
% http://tex.stackexchange.com/questions/30720/footnote-without-a-marker
\newcommand\blfootnote[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}

% How to remove indentation in footnote?
% http://tex.stackexchange.com/questions/289108/how-to-remove-indentation-in-footnote
\usepackage[hang,flushmargin]{footmisc}

\newcommand\scalemath[2]{\scalebox{#1}{\mbox{\ensuremath{\displaystyle #2}}}}

\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}

\newcommand{\Pablo}[1]{\textcolor{red}{ToDo (Pablo): #1.}}
\newcommand{\Johannes}[1]{\textcolor{blue}{ToDo (Johannes): #1.}}

% for tables
\usepackage{tabularx}
\newcolumntype{Y}{>{\centering\arraybackslash}X}
\newcolumntype{R}{>{\raggedleft\arraybackslash}X}
\newcolumntype{L}{>{\raggedright\arraybackslash}X}
\newcolumntype{M}{>{\centering\arraybackslash$}X<{$}}  % Math mode (centering)

% ToDo
\newcommand\todo[1]{\textcolor{red}{TODO: {#1}}}

% eqref with bracket also as hyperref
\renewcommand{\eqref}[1]{\hyperref[#1]{(}\ref{#1}\hyperref[#1]{)}}

% reduce space after caption
% \setlength{\belowcaptionskip}{-10pt}
\setlength{\abovecaptionskip}{6pt}

% Space-preserving figures
\setlength{\floatsep}{8pt plus2pt minus2pt}
\setlength{\textfloatsep}{8pt plus2pt minus2pt}
\setlength{\dblfloatsep}{8pt plus2pt minus2pt}
\setlength{\dbltextfloatsep}{8pt plus2pt minus2pt}

% custom paragraph
\newcommand\customparagraph[1]{\vspace{0.4em}\noindent\textbf{#1}}

% small captions
\usepackage[font=small,labelfont=bf]{caption}

% custom colors
\usepackage{xcolor}
\definecolor{cblue}{rgb}{0, 0.44, 0.75}
\definecolor{cred}{rgb}{0.75, 0, 0}

\DeclareOldFontCommand{\bf}{\normalfont\bfseries}{\mathbf}

\usepackage{lmodern}   % for 'pablo' bibliographystyle

% \url{...} size
\usepackage{url}
\renewcommand*{\UrlFont}{\small}


%%%%%%%  \ChapFrame
\usepackage{background}
\usetikzlibrary{calc}
\usepackage{ifthen}
\usepackage{lipsum}
% % background common settings
\SetBgScale{1}
\SetBgAngle{0}
\SetBgOpacity{1}
\SetBgContents{}
% auxiliary counter
\newcounter{chapshift}
\addtocounter{chapshift}{-1}
% the list of colors to be used (add more if needed)
\newcommand\BoxColor{%
  \ifcase\thechapshift cyan!30\or teal!30\or olive!30\or brown!30\or red!30\or orange!30\or blue!30\or lime!30\or magenta!30\else yellow!30\fi}
% the main command; the mandatory argument sets the color of the vertical box
\makeatletter
\newcommand\ChapFrame[1]{%
\AddEverypageHook{%
\ifthenelse{\isodd{\thepage}}
{\SetBgContents{%
  \begin{tikzpicture}[overlay,remember picture]
  \node[fill=\BoxColor,inner sep=0pt,rectangle,text width=0.3cm,
    text height=4cm,align=center,anchor=north east]
  at ($ (current page.north east) + (-0cm,-0.5cm - 4*\thechapshift cm) $)
  {\rotatebox{90}{\parbox[c][0.2cm][t]{4cm}{%
    \centering\textcolor{black}{\scshape \scriptsize Chapter\,~\,\thechapter}}}};
  \end{tikzpicture}}%
}
{\SetBgContents{%
  \begin{tikzpicture}[overlay,remember picture]
  \node[fill=\BoxColor,inner sep=0pt,rectangle,text width=0.3cm,
    text height=4cm,align=center,anchor=north west]
  at ($ (current page.north west) + (-0cm,-20 - 4*\thechapshift cm) $)
  {\rotatebox{90}{\parbox[c][0.2cm][t]{4cm}{%
    \centering\textcolor{black}{\scshape \scriptsize Chapter\,~\,\thechapter}}}};
  \end{tikzpicture}}
}
\bg@material}%
  \stepcounter{chapshift}
}
\newcommand\BoxColorEmpty{%
  \ifcase\thechapshift white!100\or white!100\or white!100\or white!100\else white!100\fi}
% \newcommand\ChapFrameEmpty{%
% \AddEverypageHook{\SetBgContents{}}
% }
\makeatletter
\newcommand\ChapFrameEmpty[1]{%
\AddEverypageHook{%
\ifthenelse{\isodd{\thepage}}
{\SetBgContents{%
  \begin{tikzpicture}[overlay,remember picture]
  \node[fill=\BoxColorEmpty,inner sep=0pt,rectangle,text width=0.3cm,
    text height=4cm,align=center,anchor=north east]
  at ($ (current page.north east) + (-0cm,-0.5cm - 4*\thechapshift cm) $)
  {\rotatebox{90}{\parbox[c][0.2cm][t]{4cm}{%
    \centering\textcolor{black}{}}}};
  \end{tikzpicture}}%
}
{\SetBgContents{%
  \begin{tikzpicture}[overlay,remember picture]
  \node[fill=\BoxColorEmpty,inner sep=0pt,rectangle,text width=0.3cm,
    text height=4cm,align=center,anchor=north west]
  at ($ (current page.north west) + (-0cm,-20 - 4*\thechapshift cm) $)
  {\rotatebox{90}{\parbox[c][0.2cm][t]{4cm}{%
    \centering\textcolor{black}{}}}};
  \end{tikzpicture}}
}
\bg@material}%
%   \stepcounter{chapshift}
}
